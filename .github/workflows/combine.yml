name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'      # Ø§Ø¬Ø±Ø§ Ù‡Ø± 2 Ø³Ø§Ø¹Øª
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs
        run: |
          echo "Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ combined.txt Ù‚Ø¨Ù„ Ø§Ø² Ø³Ø§Ø®Øª:"
          if [ -f combined.txt ]; then
            echo "ÙØ§ÛŒÙ„ combined.txt Ù‚Ø¨Ù„Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯."
          else
            echo "ÙØ§ÛŒÙ„ combined.txt ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù‚Ø±Ø§Ø±Ù‡ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯."
          fi

          echo "ğŸ“„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§ÛŒ myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "ğŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ (ÙÙ‚Ø· Ø®Ø·ÙˆØ· Ù„ÛŒÙ†Ú©)"
          grep -E '^https?://' myfeeds.txt > urls.txt

          echo "ğŸ“ Ù†ÙˆØ´ØªÙ† Ù‡Ø¯Ø±Ù‡Ø§ Ø¯Ø± combined.txt"
          echo "$HEADER_LINES" > combined.txt

          while read url; do
            echo "â¬‡ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² $url"
            content=$(curl -s "$url")

            if echo "$content" | grep -qE '^[A-Za-z0-9+/=\n\r]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null)
              if [ $? -eq 0 ] && [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            configs=$(echo "$content" | grep -E '^(vless|vmess)://' || true)

            echo "$configs" >> combined.txt

            # sleep 1  # Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ Ø¨ÙˆØ¯ ÙØ¹Ø§Ù„ Ú©Ù†
          done < urls.txt

          echo "ğŸ§¹ Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø² combined.txt"
          sort combined.txt | uniq > combined_unique.txt
          mv combined_unique.txt combined.txt

          echo "ğŸ“„ Ù…Ø­ØªÙˆØ§ÛŒ combined.txt (10 Ø®Ø· Ø§ÙˆÙ„):"
          head -n 10 combined.txt

          echo "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø®Ø·ÙˆØ· combined.txt:"
          wc -l combined.txt

      - name: Commit and push combined.txt
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add combined.txt

          echo "ÙˆØ¶Ø¹ÛŒØª git Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÙØ²ÙˆØ¯Ù† combined.txt:"
          git status

          git diff --cached --quiet && echo "âœ… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ commit Ù†ÛŒØ³Øª." || (
            git commit -m "ğŸ”„ Auto update combined subscription" &&
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
          )

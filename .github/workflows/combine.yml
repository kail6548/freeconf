name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'      # اجرا هر ۲ ساعت
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs
        run: |
          echo "📄 خواندن هدرهای myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "🌐 استخراج لینک‌ها (فقط خطوط لینک)"
          grep -E '^https?://' myfeeds.txt > urls.txt

          echo "📝 نوشتن هدرها در combined.txt"
          echo "$HEADER_LINES" > combined.txt

          while read url; do
            echo "⬇️ دریافت از $url"
            content=$(curl -s "$url")

            if echo "$content" | grep -qE '^[A-Za-z0-9+/=]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null)
              if [ $? -eq 0 ] && [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            configs=$(echo "$content" | grep -E '^(vless|vmess|trojan|ss|socks|hysteria|tuic)://' || true)
            echo "$configs" >> combined.txt

            # sleep 1  # ← اگر نیاز شد، برای ریت‌لیمیت کامنت بردار
          done < urls.txt

      - name: Remove duplicates via Python
        run: |
          echo "🧹 حذف کانفیگ‌های تکراری با پایتون (بر اساس URI بدون #tag)"
          python3 <<'EOF' < combined.txt > combined_cleaned.txt
import sys
seen = set()
for line in sys.stdin:
    line = line.strip()
    if not line:
        continue
    if line.startswith("//"):
        print(line)
        continue
    if "://" not in line:
        continue
    key = line.split('#')[0].lower()
    if key not in seen:
        seen.add(key)
        print(line)
EOF
          mv combined_cleaned.txt combined.txt

          echo "📄 محتوای combined.txt (10 خط اول):"
          head -n 10 combined.txt

          echo "📊 تعداد کل خطوط combined.txt:"
          wc -l combined.txt

      - name: Commit and push combined.txt
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add combined.txt
          git diff --cached --quiet && echo "✅ بدون تغییر، نیازی به commit نیست." || (
            git commit -m "🔄 Auto update combined subscription" &&
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
          )

name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'      # ุงุฌุฑุง ูุฑ ฒ ุณุงุนุช
  workflow_dispatch:           # ุงุฌุฑุง ุฏุณุช

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      # ูุฑุญูู ฑ: ุฏุฑุงูุช ุณูุฑุณ ุฑูพู
      - name: Checkout repository
        uses: actions/checkout@v3

      # ูุฑุญูู ฒ: ุชุฑฺฉุจ ฺฉุงููฺฏโูุง
      - name: Combine configs
        run: |
          echo "๐ ุฎูุงูุฏู ูุฏุฑูุง myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "๐ ุงุณุชุฎุฑุงุฌ ููฺฉโูุง ุงุฒ myfeeds.txt"
          grep '^http' myfeeds.txt > urls.txt

          echo "๐ ููุดุชู ูุฏุฑูุง ุฏุฑ combined.txt"
          echo "$HEADER_LINES" > combined.txt

          echo "๐ ุดุฑูุน ุฏุงูููุฏ ู ููุชุฑ ฺฉุงููฺฏโูุง"
          COUNT=0
          MAX=200000  # ูุญุฏูุฏุช ุจุณุงุฑ ุจุงูุง (ุชูุฑุจุงู ุจโููุงุช)

          while read url; do
            echo "โฌ๏ธ ุฏุฑุงูุช ุงุฒ $url"
            content=$(curl -s "$url")

            # ููุท ุฎุทูุท ฺฉู ุจุง vless:// ุง vmess:// ุดุฑูุน ูโุดู
            configs=$(echo "$content" | grep -E '^(vless|vmess)://')

            # ุงูุฒูุฏู ุจู ูุงู ุฎุฑูุฌ
            echo "$configs" >> combined.txt

            # ุดูุงุฑุด ฺฉุงููฺฏโูุง
            COUNT=$((COUNT + $(echo "$configs" | wc -l)))

            # โ ุงฺฏุฑ ูโุฎูุง ูุญุฏูุฏุช ุฏุงุดุชู ุจุงุดูุ ุงู ุจุฎุด ุฑู ุงุฒ ุญุงูุช ฺฉุงููุช ุฎุงุฑุฌ ฺฉู
            # if [ "$COUNT" -ge "$MAX" ]; then
            #   echo "๐ซ ุฑุณุฏู ุจู ุญุฏ $MAX ฺฉุงููฺฏ. ูุชููู ูโุดู."
            #   break
            # fi

            # ๐ค ุงฺฏุฑ ูโุฎูุง ุจู ุฏุฑุฎูุงุณุชโูุง ูุงุตูู ุจุงุดู ุจุฑุง ุฌููฺฏุฑ ุงุฒ rate limitุ ุงู ุฎุท ุฑู ูุนุงู ฺฉู:
            # sleep 1

          done < urls.txt

      # ูุฑุญูู ณ: commit ู push ุฏุฑ ุตูุฑุช ุชุบุฑ ูุงู combined.txt
      - name: Commit and push combined.txt
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add combined.txt

          # ููุท ุงฺฏู ูุงู ุชุบุฑ ฺฉุฑุฏู ุจูุฏ commit ฺฉู
          git diff --quiet && echo "โ ุจุฏูู ุชุบุฑุ ูุงุฒ ุจู commit ูุณุช." || git commit -m "๐ Auto update combined subscription"
          git push

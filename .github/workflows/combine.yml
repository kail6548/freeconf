name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'      # ุงุฌุฑุง ูุฑ 2 ุณุงุนุช
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs
        run: |
          echo "๐ ุฎูุงูุฏู ูุฏุฑูุง myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "๐ ุงุณุชุฎุฑุงุฌ ููฺฉโูุง (ููุท ุฎุทูุท ููฺฉ)"
          grep -E '^https?://' myfeeds.txt > urls.txt

          echo "๐ ููุดุชู ูุฏุฑูุง ุฏุฑ combined.txt"
          echo "$HEADER_LINES" > combined.txt

          COUNT=0
          MAX=200000  # ูุญุฏูุฏุช ุจุณุงุฑ ุจุงูุง (ุฏุฑ ุตูุฑุช ูุงุฒุ ุงู ุจุฎุด ุฑู ุงุฒ ุญุงูุช ฺฉุงููุช ุฎุงุฑุฌ ฺฉู)

          while read url; do
            echo "โฌ๏ธ ุฏุฑุงูุช ุงุฒ $url"
            content=$(curl -s "$url")

            # ุชุดุฎุต ูุญุชูุง base64 ุจูุฏู
            if echo "$content" | grep -qE '^[A-Za-z0-9+/=\n\r]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null)
              if [ $? -eq 0 ] && [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            # ุงุณุชุฎุฑุงุฌ ฺฉุงููฺฏโูุง
            configs=$(echo "$content" | grep -E '^(vless|vmess)://' || true)

            echo "$configs" >> combined.txt

            # ุดูุงุฑุด ุชุนุฏุงุฏ ฺฉุงููฺฏโูุง
            COUNT=$((COUNT + $(echo "$configs" | wc -l)))

            # ูุญุฏูุฏุช ุชุนุฏุงุฏ (ุฏุฑ ุตูุฑุช ูุงุฒ ุงู ุจุฎุด ุฑู ูุนุงู ฺฉู)
            # if [ "$COUNT" -ge "$MAX" ]; then
            #   echo "๐ซ ุฑุณุฏู ุจู ุญุฏ $MAX ฺฉุงููฺฏ. ูุชููู ูโุดู."
            #   break
            # fi

            # ุชููู ุจุฑุง ุฌููฺฏุฑ ุงุฒ rate limit (ุฏุฑ ุตูุฑุช ูุงุฒ ูุนุงู ฺฉู)
            # sleep 1

          done < urls.txt

      - name: Commit and push combined.txt
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add combined.txt

          git diff --quiet && echo "โ ุจุฏูู ุชุบุฑุ ูุงุฒ ุจู commit ูุณุช." || git commit -m "๐ Auto update combined subscription"
          git push

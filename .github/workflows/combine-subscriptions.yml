name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'   # Ø§Ø¬Ø±Ø§ Ù‡Ø± Û² Ø³Ø§Ø¹Øª
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs from URLs
        run: |
          echo "ğŸ“„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§ÛŒ myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "ğŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§"
          grep -E '^https?://' myfeeds.txt > urls.txt

          echo "ğŸ“ Ù†ÙˆØ´ØªÙ† Ù‡Ø¯Ø±Ù‡Ø§ Ø¯Ø± combined.txt"
          echo "$HEADER_LINES" > combined.txt

          while read -r url || [[ -n "$url" ]]; do
            echo "â¬‡ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² $url"
            content=$(curl -fsSL --max-time 20 "$url" || true)
            if [ -z "$content" ]; then
              echo "âš ï¸ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù…ÙˆÙÙ‚ Ø§Ø² $urlØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…..."
              continue
            fi

            # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ base64 Ø¨ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§
            if echo "$content" | grep -qE '^[A-Za-z0-9+/=[:space:]]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null || true)
              if [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            # Ù†ÙˆØ´ØªÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø¯ÙˆÙ† echo Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Broken Pipe
            echo "$content" | grep -E '^[a-zA-Z0-9\-]+://' >> combined.txt || true

            sleep 1  # Ú©Ø§Ù‡Ø´ ÙØ´Ø§Ø± Ø±ÙˆÛŒ Ø­Ø§ÙØ¸Ù‡

          done < urls.txt

      - name: Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ (Python)
        run: |
          echo "ğŸ” Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ..."
          python3 remove_duplicates.py > combined_cleaned.txt
          mv combined_cleaned.txt combined.txt

          echo "ğŸ“„ Ù†Ù…Ø§ÛŒØ´ 10 Ø®Ø· Ø§ÙˆÙ„ combined.txt:"
          head -n 10 combined.txt

          echo "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ· combined.txt:"
          wc -l combined.txt

      - name: Create combined_random.txt with 500 random configs
        run: |
          echo "ğŸ² Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ combined_random.txt Ø¨Ø§ ÛµÛ°Û° Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ù†Ø¯ÙˆÙ…"

          HEADER_END=$(grep -n -m1 -v '^//' combined.txt | cut -d: -f1)

          grep '^//' combined.txt | grep -v '^//profile-title:' > temp_header.txt

          echo "//profile-title: Free_Config_Random" > random_header.txt
          cat temp_header.txt >> random_header.txt
          rm -f temp_header.txt

          tail -n +$((HEADER_END + 1)) combined.txt > configs_only.txt
          TOTAL_LINES=$(wc -l < configs_only.txt)
          if [ "$TOTAL_LINES" -le 500 ]; then
            cp configs_only.txt random_configs.txt
          else
            shuf -n 500 configs_only.txt > random_configs.txt
          fi

          cat random_header.txt random_configs.txt > combined_random.txt
          rm -f random_header.txt configs_only.txt random_configs.txt

      - name: Encode combined.txt to base64 (overwrite original)
        run: |
          echo "ğŸ” ØªØ¨Ø¯ÛŒÙ„ combined.txt Ø¨Ù‡ base64..."
          base64 -w 0 combined.txt > tmp.txt && mv tmp.txt combined.txt
          echo "âœ… ÙØ§ÛŒÙ„ base64 Ø´Ø¯Ù‡ Ø¯Ø± combined.txt Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯."

      - name: Encode combined_random.txt to base64 (overwrite original)
        run: |
          echo "ğŸ” ØªØ¨Ø¯ÛŒÙ„ combined_random.txt Ø¨Ù‡ base64..."
          base64 -w 0 combined_random.txt > tmp_random.txt && mv tmp_random.txt combined_random.txt
          echo "âœ… ÙØ§ÛŒÙ„ base64 Ø´Ø¯Ù‡ Ø¯Ø± combined_random.txt Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯."

      - name: Generate README with subscription links
        run: |
          echo "ğŸ“˜ Ø³Ø§Ø®Øª README.md Ø¨Ø§ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…"

          RAW_LINK="https://raw.githubusercontent.com/${{ github.repository }}/main/combined.txt"
          RAW_LINK_RANDOM="https://raw.githubusercontent.com/${{ github.repository }}/main/combined_random.txt"

          echo "# ğŸ”— Combined Subscription (Base64)" > README.md
          echo "" >> README.md
          echo "This repository auto-generates a deduplicated, base64-encoded subscription file every 2 hours." >> README.md
          echo "" >> README.md
          echo "## ğŸ“¥ Direct Subscription Links" >> README.md
          echo "" >> README.md
          echo "### Full combined file:" >> README.md
          echo '```' >> README.md
          echo "$RAW_LINK" >> README.md
          echo '```' >> README.md
          echo "" >> README.md
          echo "### Random 500 configs file:" >> README.md
          echo '```' >> README.md
          echo "$RAW_LINK_RANDOM" >> README.md
          echo '```' >> README.md
          echo "" >> README.md
          echo "Updated automatically via GitHub Actions." >> README.md

      - name: Commit and push if changed
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add combined.txt combined_random.txt README.md

          if git diff --cached --quiet; then
            echo "âœ… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ commit Ù†ÛŒØ³Øª."
          else
            git commit -m "ğŸ”„ Auto update combined files and README"
            git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}" HEAD:main
          fi

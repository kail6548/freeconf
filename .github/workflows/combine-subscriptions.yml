name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'  # Ù‡Ø± 2 Ø³Ø§Ø¹Øª Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract URLs from feeds files
        run: |
          echo "ðŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø§Ø² Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ feeds"
          mkdir -p output
          grep -hE '^https?://' feeds/*.txt | sort | uniq > urls.txt
          grep -h '^//' feeds/*.txt | sort | uniq > header.txt

      - name: Download and combine configs
        run: |
          echo "ðŸ“ Ù†ÙˆØ´ØªÙ† Ù‡Ø¯Ø±Ù‡Ø§ Ø¯Ø± output/combined.txt"
          cat header.txt > output/combined.txt

          while read -r url; do
            echo "â¬‡ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² $url"
            content=$(curl -s "$url")

            # Ú†Ú© Ú©Ø±Ø¯Ù† base64 Ø¨ÙˆØ¯Ù† Ùˆ Ø¯ÛŒÚ©Ø¯ Ú©Ø±Ø¯Ù† Ø§Ú¯Ø± Ù‡Ø³Øª
            if echo "$content" | grep -qE '^[A-Za-z0-9+/=[:space:]]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null || echo "")
              if [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø®Ø·ÙˆØ· Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù‡ Ø¨Ø§ Ù¾Ø±ÙˆØªÚ©Ù„ Ø´Ø±ÙˆØ¹ Ù…ÛŒØ´Ù‡
            configs=$(echo "$content" | grep -E '^[a-zA-Z0-9\-]+://')
            echo "$configs" >> output/combined.txt
          done < urls.txt

      - name: Remove duplicate configs with Python
        run: |
          echo "ðŸ” Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ..."
          python3 scripts/remove_duplicates.py output/combined.txt output/combined_cleaned.txt

      - name: Encode combined file to base64
        run: |
          base64 output/combined_cleaned.txt > output/combined_base64.txt

      - name: Generate README file
        run: |
          python3 scripts/generate_readme.py output/combined_cleaned.txt README.md

      - name: Commit and push if changed
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add output/combined_base64.txt README.md
          if git diff --cached --quiet; then
            echo "âœ… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ commit Ù†ÛŒØ³Øª."
          else
            git commit -m "ðŸ”„ Auto update combined subscription and README"
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
          fi

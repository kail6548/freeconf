name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'   # Ù‡Ø± Û² Ø³Ø§Ø¹Øª Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs from URLs
        run: |
          echo "ðŸ“„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§ÛŒ myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "ðŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§"
          grep -E '^https?://' myfeeds.txt > urls.txt

          echo "ðŸ“ Ù†ÙˆØ´ØªÙ† Ù‡Ø¯Ø±Ù‡Ø§ Ø¯Ø± combined.txt (Ù‚Ø¨Ù„ Ø§Ø² base64)"
          echo "$HEADER_LINES" > combined_raw.txt

          while read -r url; do
            echo "â¬‡ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² $url"
            content=$(curl -s "$url")

            # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ù…Ø­ØªÙˆØ§ base64 Ù‡Ø³Øª ÛŒØ§ Ø®ÛŒØ±
            if echo "$content" | grep -qE '^[A-Za-z0-9+/=[:space:]]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null || echo "")
              if [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡Ù…Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ Ù¾Ø±ÙˆØªÚ©Ù„ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
            configs=$(echo "$content" | grep -E '^[a-zA-Z0-9\-]+://')
            echo "$configs" >> combined_raw.txt
          done < urls.txt

      - name: Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ (Python)
        run: |
          echo "ðŸ” Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ..."
          python3 remove_duplicates.py < combined_raw.txt > combined_cleaned_raw.txt
          mv combined_cleaned_raw.txt combined_raw.txt

      - name: Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ combined.txt base64 Ø´Ø¯Ù‡
        run: |
          echo "ðŸ§¬ base64 Ú©Ø±Ø¯Ù† combined.txt"
          base64 combined_raw.txt > combined.txt

      - name: Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ combined_random.txt Ø¨Ø§ ÛµÛ°Û° Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ù†Ø¯ÙˆÙ… base64 Ø´Ø¯Ù‡
        run: |
          echo "ðŸŽ² Ø§Ù†ØªØ®Ø§Ø¨ ÛµÛ°Û° Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ù†Ø¯ÙˆÙ… Ø§Ø² combined_raw.txt"
          # Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§ (Ø®Ø·â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ // Ø´Ø±ÙˆØ¹ Ù…ÛŒØ´Ù†)
          head -n $(grep -n -m1 -v '^//' combined_raw.txt | cut -d: -f1) combined_raw.txt > random_header.txt || echo "" > random_header.txt

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† Ù‡Ø¯Ø±
          tail -n +$(( $(grep -n -m1 -v '^//' combined_raw.txt | cut -d: -f1) + 1 )) combined_raw.txt > configs_only.txt

          total_lines=$(wc -l < configs_only.txt)

          if [ "$total_lines" -le 500 ]; then
            echo "ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ú©Ù…ØªØ± Ø§Ø² ÛµÛ°Û° Ø§Ø³ØªØŒ Ù‡Ù…Ù‡ Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ Ø±Ù†Ø¯ÙˆÙ… Ù…ÛŒâ€ŒØ±ÛŒØ²ÛŒÙ…."
            cat configs_only.txt > random_configs.txt
          else
            shuf -n 500 configs_only.txt > random_configs.txt
          fi

          # Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ random Ø¨Ø§ Ù‡Ø¯Ø±
          cat random_header.txt random_configs.txt > combined_random_raw.txt

          # base64 Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø±Ù†Ø¯ÙˆÙ…
          base64 combined_random_raw.txt > combined_random.txt

          # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
          rm -f random_header.txt configs_only.txt random_configs.txt combined_random_raw.txt

      - name: Ø§ÛŒØ¬Ø§Ø¯ README.md Ø¨Ø§ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… raw ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        run: |
          echo "ðŸ“„ Ø³Ø§Ø®Øª README.md"
          raw_base_url="https://raw.githubusercontent.com/${{ github.repository }}/main"
          cat > README.md <<EOF
# Subscription Files

## Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§:

- [combined.txt](${raw_base_url}/combined.txt)
- [combined_random.txt](${raw_base_url}/combined_random.txt)

EOF

      - name: Commit and push if changed
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add combined.txt combined_random.txt README.md
          if git diff --cached --quiet; then
            echo "âœ… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ commit Ù†ÛŒØ³Øª."
          else
            git commit -m "ðŸ”„ Auto update combined files (base64) and README with direct raw links"
            git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:main
          fi

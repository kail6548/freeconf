name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'   # Ø§Ø¬Ø±Ø§ Ù‡Ø± Û² Ø³Ø§Ø¹Øª
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs from URLs with counts
        run: |
          # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÙˆÙ‚Ù Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± ÛŒÚ© Ø¯Ø³ØªÙˆØ±
          set +e

          echo "ğŸ“„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§ÛŒ myfeeds.txt"
          grep '^//' myfeeds.txt > header.txt || true

          echo "ğŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§"
          grep -E '^https?://' myfeeds.txt > urls.txt || true

          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ù‡Ø¯Ø±
          if [ -f "header.txt" ]; then
            cat header.txt > combined.txt
            rm header.txt
          else
            > combined.txt
          fi

          mkdir -p url_configs
          rm -f url_configs/*.txt
          
          > all_configs.txt

          i=0
          while read -r url || [[ -n "$url" ]]; do
            i=$((i+1))
            echo "-----------------------------------------------------"
            echo "â¬‡ï¸ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© $i: $url"
            
            echo "ğŸ“¥ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯..."
            curl -L --retry 3 --connect-timeout 30 --max-time 300 -fsS "$url" -o temp_content.txt
            
            if [ ! -s temp_content.txt ]; then
              echo "âš ï¸ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù…ÙˆÙÙ‚ ÛŒØ§ ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø² $urlØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…..."
              rm -f temp_content.txt
              continue
            fi
            echo "ğŸ“¦ Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡: $(du -h temp_content.txt | cut -f1)"

            # âœ¨ ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯ÙˆÚ¯Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ù‚Øª
            > url_temp_configs.txt

            # Ù…Ø±Ø­Ù„Ù‡ Û±: Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…ØªÙ† Ø³Ø§Ø¯Ù‡
            awk '/^[a-zA-Z0-9\-]+:\/\//' temp_content.txt >> url_temp_configs.txt
            count_plain=$(wc -l < url_temp_configs.txt)
            echo "ğŸ” ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø¯Ø± Ø­Ø§Ù„Øª Ù…ØªÙ†ÛŒ: $count_plain"

            # Ù…Ø±Ø­Ù„Ù‡ Û²: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Base64
            base64 -d temp_content.txt > temp_decoded.txt 2>/dev/null || true
            if [ -s temp_decoded.txt ]; then
              awk '/^[a-zA-Z0-9\-]+:\/\//' temp_decoded.txt >> url_temp_configs.txt
              count_base64=$(wc -l < url_temp_configs.txt)
              echo "ğŸ” ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ Base64: $count_base64"
            fi
            rm -f temp_decoded.txt

            # Ù…Ø±Ø­Ù„Ù‡ Û³: Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú©
            if [ -s url_temp_configs.txt ]; then
              sort -u url_temp_configs.txt > "url_configs/url_${i}.txt"
              count_final=$(wc -l < "url_configs/url_${i}.txt")
              echo "ğŸ”¢ ØªØ¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú©: $count_final"
              # Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ÛŒÚ©ØªØ§ÛŒ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ù„ÛŒ
              cat "url_configs/url_${i}.txt" >> all_configs.txt
            else
              echo "ğŸ”¢ ØªØ¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú©: 0"
            fi
            
            rm -f url_temp_configs.txt temp_content.txt
            sleep 1
          done < urls.txt

          # Ø§ÙØ²ÙˆØ¯Ù† ØªÙ…Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø´Ø¯Ù‡ Ø¨Ù‡ ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ
          # Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ù‡Ù†ÙˆØ² Ø­Ø§ÙˆÛŒ ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ† Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø§Ø³Øª
          mv all_configs.txt temp_all_configs.txt
          cat temp_all_configs.txt >> combined.txt
          rm temp_all_configs.txt

      - name: Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ (Python)
        run: |
          echo "ğŸ” Ø­Ø°Ù Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ..."
          if [ -f "remove_duplicates.py" ]; then
            HEADER_END_LINE=$(grep -n -m1 -v '^//' combined.txt | cut -d: -f1)
            if [ -z "$HEADER_END_LINE" ]; then
              echo "â„¹ï¸ Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."
            else
              echo "ğŸ” Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ù‡Ø¯Ø± Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§..."
              head -n $((HEADER_END_LINE - 1)) combined.txt > header.txt
              tail -n +$HEADER_END_LINE combined.txt > configs_only.txt
              echo "ğŸ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ†..."
              python3 remove_duplicates.py < configs_only.txt > cleaned_configs.txt
              echo "ğŸ”„ ØªØ±Ú©ÛŒØ¨ Ù…Ø¬Ø¯Ø¯ ÙØ§ÛŒÙ„..."
              cat header.txt cleaned_configs.txt > combined.txt
              rm header.txt configs_only.txt cleaned_configs.txt
              echo "âœ… Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯."
            fi
          else
            echo "âš ï¸ ÙØ§ÛŒÙ„ remove_duplicates.py ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø§Ø² Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒ ØµØ±Ùâ€ŒÙ†Ø¸Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯."
          fi
          echo "ğŸ“„ Ù†Ù…Ø§ÛŒØ´ Û±Û° Ø®Ø· Ø§ÙˆÙ„ combined.txt:"
          head -n 10 combined.txt
          echo "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø®Ø·ÙˆØ· combined.txt:"
          wc -l combined.txt

      - name: Count configs remaining per URL after deduplication
        run: |
          echo "ğŸ”¢ Ø´Ù…Ø§Ø±Ø´ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù‡Ø± Ù„ÛŒÙ†Ú© Ù¾Ø³ Ø§Ø² Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§"
          HEADER_END=$(grep -n -m1 -v '^//' combined.txt | cut -d: -f1 || echo 1)
          tail -n +$HEADER_END combined.txt > combined_configs_only.txt
          for file in url_configs/url_*.txt; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              url_index="${filename//[!0-9]/}"
              total_before=$(wc -l < "$file")
              count_after=$(grep -Fxf "$file" combined_configs_only.txt | wc -l || true)
              echo "Ù„ÛŒÙ†Ú© $url_index: Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„: $total_before | Ø¨Ø¹Ø¯ Ø§Ø² Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒ: $count_after"
            fi
          done
          rm combined_configs_only.txt

      - name: Create combined_random.txt with 500 random configs
        run: |
          echo "ğŸ² Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ combined_random.txt Ø¨Ø§ ÛµÛ°Û° Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ù†Ø¯ÙˆÙ…"
          HEADER_END=$(grep -n -m1 -v '^//' combined.txt | cut -d: -f1 || echo 1)
          grep '^//' combined.txt | grep -v '^//profile-title:' > temp_header.txt
          echo "//profile-title: Free_Config_Random" > random_header.txt
          cat temp_header.txt >> random_header.txt
          rm -f temp_header.txt
          tail -n +$HEADER_END combined.txt > configs_only.txt
          TOTAL_LINES=$(wc -l < configs_only.txt)
          if [ "$TOTAL_LINES" -le 500 ]; then
            cp configs_only.txt random_configs.txt
          else
            shuf -n 500 configs_only.txt > random_configs.txt
          fi
          cat random_header.txt random_configs.txt > combined_random.txt
          rm -f random_header.txt configs_only.txt random_configs.txt

      - name: Encode combined.txt to base64 (overwrite original)
        run: |
          echo "ğŸ” ØªØ¨Ø¯ÛŒÙ„ combined.txt Ø¨Ù‡ base64..."
          base64 -w 0 combined.txt > tmp.txt && mv tmp.txt combined.txt
          echo "âœ… ÙØ§ÛŒÙ„ base64 Ø´Ø¯Ù‡ Ø¯Ø± combined.txt Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯."

      - name: Encode combined_random.txt to base64 (overwrite original)
        run: |
          echo "ğŸ” ØªØ¨Ø¯ÛŒÙ„ combined_random.txt Ø¨Ù‡ base64..."
          base64 -w 0 combined_random.txt > tmp_random.txt && mv tmp_random.txt combined_random.txt
          echo "âœ… ÙØ§ÛŒÙ„ base64 Ø´Ø¯Ù‡ Ø¯Ø± combined_random.txt Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯."

      - name: Generate README with subscription links
        run: |
          echo "ğŸ“˜ Ø³Ø§Ø®Øª README.md Ø¨Ø§ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…"
          RAW_LINK="https://raw.githubusercontent.com/${{ github.repository }}/main/combined.txt"
          RAW_LINK_RANDOM="https://raw.githubusercontent.com/${{ github.repository }}/main/combined_random.txt"
          echo "# ğŸ”— Combined Subscription (Base64)" > README.md
          echo "" >> README.md
          echo "This repository auto-generates a deduplicated, base64-encoded subscription file every 2 hours." >> README.md
          echo "" >> README.md
          echo "## ğŸ“¥ Direct Subscription Links" >> README.md
          echo "" >> README.md
          echo "### Full combined file:" >> README.md
          echo '```' >> README.md
          echo "$RAW_LINK" >> README.md
          echo '```' >> README.md
          echo "" >> README.md
          echo "### Random 500 configs file:" >> README.md
          echo '```' >> README.md
          echo "$RAW_LINK_RANDOM" >> README.md
          echo '```' >> README.md
          echo "" >> README.md
          echo "Updated automatically via GitHub Actions." >> README.md

      - name: Commit and push if changed
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add combined.txt combined_random.txt README.md
          if git diff --cached --quiet; then
            echo "âœ… Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ commit Ù†ÛŒØ³Øª."
          else
            git commit -m "ğŸ”„ Auto update combined files and README"
            git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}" HEAD:main
          fi

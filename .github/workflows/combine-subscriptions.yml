name: Combine Subscription Files

on:
  schedule:
    - cron: '0 */2 * * *'   # اجرا هر ۲ ساعت
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Combine configs from URLs
        run: |
          echo "📄 خواندن هدرهای myfeeds.txt"
          HEADER_LINES=$(grep '^//' myfeeds.txt)

          echo "🌐 استخراج لینک‌ها"
          grep -E '^https?://' myfeeds.txt > urls.txt

          echo "📝 نوشتن هدرها در combined.txt"
          echo "$HEADER_LINES" > combined.txt

          while read -r url; do
            echo "⬇️ دریافت از $url"
            content=$(curl -s "$url")

            if echo "$content" | grep -qE '^[A-Za-z0-9+/=[:space:]]+$'; then
              decoded=$(echo "$content" | base64 -d 2>/dev/null || echo "")
              if [ -n "$decoded" ]; then
                content="$decoded"
              fi
            fi

            configs=$(echo "$content" | grep -E '^[a-zA-Z0-9\-]+://')
            echo "$configs" >> combined.txt

          done < urls.txt

      - name: حذف کانفیگ‌های تکراری (Python)
        run: |
          echo "🔍 حذف کانفیگ‌های تکراری..."
          python3 remove_duplicates.py > combined_cleaned.txt
          mv combined_cleaned.txt combined.txt

          echo "📄 نمایش 10 خط اول combined.txt:"
          head -n 10 combined.txt

          echo "📊 تعداد خطوط combined.txt:"
          wc -l combined.txt

      - name: ساخت فایل combined_random.txt با ۵۰۰ کانفیگ رندوم
        run: |
          echo "🎲 انتخاب ۵۰۰ کانفیگ رندوم از combined.txt"
          head -n $(grep -n -m1 -v '^//' combined.txt | cut -d: -f1) combined.txt > random_header.txt || echo "" > random_header.txt
          echo "//profile-title: Free_Config (500 random)" >> random_header.txt
          tail -n +$(( $(grep -n -m1 -v '^//' combined.txt | cut -d: -f1) + 1 )) combined.txt > configs_only.txt

          total_lines=$(wc -l < configs_only.txt)
          if [ "$total_lines" -le 500 ]; then
            cat configs_only.txt > random_configs.txt
          else
            shuf -n 500 configs_only.txt > random_configs.txt
          fi

          cat random_header.txt random_configs.txt > combined_random.txt
          rm -f random_header.txt configs_only.txt random_configs.txt

      - name: Encode combined.txt to base64 (overwrite original)
        run: |
          echo "🔐 تبدیل combined.txt به base64..."
          base64 -w 0 combined.txt > tmp.txt && mv tmp.txt combined.txt
          echo "✅ فایل base64 شده در combined.txt ذخیره شد."

      - name: Encode combined_random.txt to base64 (overwrite original)
        run: |
          echo "🔐 تبدیل combined_random.txt به base64..."
          base64 -w 0 combined_random.txt > tmp_random.txt && mv tmp_random.txt combined_random.txt
          echo "✅ فایل base64 شده در combined_random.txt ذخیره شد."

      - name: Generate README with subscription links
        run: |
          echo "📘 ساخت README.md با لینک‌های مستقیم"

          RAW_LINK_COMBINED="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/combined.txt"
          RAW_LINK_RANDOM="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/combined_random.txt"

          echo "# 🔗 Combined Subscription (Base64)" > README.md
          echo "" >> README.md
          echo "This repository auto-generates deduplicated, base64-encoded subscription files every 2 hours." >> README.md
          echo "" >> README.md
          echo "## 📥 Direct Subscription Links" >> README.md
          echo "" >> README.md
          echo "### Full combined file:" >> README.md
          echo '```' >> README.md
          echo "$RAW_LINK_COMBINED" >> README.md
          echo '```' >> README.md
          echo "" >> README.md
          echo "### Random 500 configs file:" >> README.md
          echo '```' >> README.md
          echo "$RAW_LINK_RANDOM" >> README.md
          echo '```' >> README.md
          echo "" >> README.md
          echo "Updated automatically via GitHub Actions." >> README.md

      - name: Commit and push if changed
        env:
          TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          REPO="${GITHUB_REPOSITORY}"

          git add combined.txt combined_random.txt README.md
          if git diff --cached --quiet; then
            echo "✅ بدون تغییر، نیازی به commit نیست."
          else
            git commit -m "🔄 Auto update combined files and README with random sample"
            git push https://x-access-token:${TOKEN}@github.com/${REPO} HEAD:main
